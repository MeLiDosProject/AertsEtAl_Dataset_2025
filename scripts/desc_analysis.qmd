---
title: "Descriptive analysis"
author: "Johannes Zauner"
format: 
  html:
    self-contained: true
    code-tools: true
---

# Preface

This is a work-in-progress descriptive analysis of the `AertsEtAl2025` dataset.

```{r}
#| label: setup
#| include: false
library(LightLogR)
library(glue)
library(tidyverse)
library(gt)
library(readxl)
library(cowplot)
library(legendry)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(patchwork)
library(rlang)
library(here)

source("https://raw.githubusercontent.com/MeLiDosProject/Data_Metadata_Conventions/main/scripts/overview_plot.R")

```

# Overview

## Data import: wearable data

The first step is the import of wearable data from the `head` position (mounted on glasses).

```{r}
#| label: "general information"
#time zone of Delft
tz <-  "Europe/Brussels"
#coordinates for Delft
coordinates <- c(52.0116, 4.3571)
#regex to extract participant Id and wearing position
# pattern <- "[A-Z]+_S[0-9]{3}_[hcw]"
#regex to extract participant Id
pattern <- "[A-Z]+_S[0-9]{3}"

country_colors <- c(
  Sweden     = "#88CCEE",  # Sky blue
  Spain      = "#CC6677",  # Coral red
  Germany    = "#DDCC77",  # Mustard yellow
  `The Netherlands`= "#117733",  # Dark green
  Turkey     = "#332288",  # Indigo
  Ghana      = "#AA4499",  # Purple-pink
  Costa_Rica = "#44AA99"   # Teal
)

```

```{r}
#path to participants
path_part1 <- "../data/raw/individual"
#path to actlumus data sans wearing position
path_part2 <- "/continuous/actlumus_"
#wearing position
wearing_position <- "chest"
#getting all subfolders
folders <- dir(path_part1)
#creating complete folder names
paths <- glue("{path_part1}/{folders}{path_part2}{wearing_position}")
#collecting file names
files <- list.files(paths, pattern = "\\.txt", full.names = TRUE)
files <- files[str_detect(files, "Report", negate = TRUE)]
```

```{r}
#participant S015 (chest) had a non-synchronized device and needs to be removed from analysis until re-adjusted
data <- import$ActLumus(files[c(1:9,11:15)], tz = tz, auto.id = pattern, dst_adjustment = TRUE)
```

## Regularizing data

In the first step, we will trim the data by the study time.

```{r}
#import table with study times
Study_dates_MeLiDos <- read_excel("../data/Study_dates_MeLiDos_THUAS.xlsx")
#gather the important information
Study_dates_MeLiDos <-
  Study_dates_MeLiDos |> 
    rename(Id = subjectID_device, start = datetime_trial_start, end = datetime_trial_end) |> 
    select(Id, start, end) |> 
    mutate(
      across(c(start, end), \(x) force_tz(x, tz)),
      trial = TRUE) |> 
    filter(str_detect(Id, "_c$")) |>
    mutate(Id = str_remove(Id, "_c$")) |> 
  group_by(Id)

#add the trim information to the dataset and filter by it
data <- 
  data |> 
  add_states(Study_dates_MeLiDos) |> 
  dplyr::filter(trial) |> 
  select(-trial)

data |> gg_overview()
```


```{r}
data |> has_gaps()
data |> has_irregulars()
data |> gg_gaps(group.by.days = TRUE, show.irregulars = TRUE, full.days = FALSE)

```

Only one day remains with gap/irregular data. This is due to the daylight savings time jump.

```{r}
#| fig-height: 15
#| fig-width: 5
data_cleaned <- 
data |> 
  gap_handler(full.days = TRUE) #remove implicit gaps

data_cleaned |> has_gaps() #no more implicit gaps
data_cleaned |> has_irregulars() #no more irregular data
data_cleaned |> gap_table(MEDI) |> cols_hide(ends_with("_n"))
```

## Exporting hourly values

```{r}
data_export <- 
data_cleaned |> 
  aggregate_Datetime("1 minute", numeric.handler = \(x) mean(x, na.rm = TRUE)) |> 
  remove_partial_data(MEDI, threshold.missing = "3 hours", by.date = TRUE)

save(data_export, file = "../data/imported/light/nl_1minute.RData")
```

## Visualization

```{r}
#| warning: false
#| message: false
#| fig-height: 8
#| fig-width: 12

data_cleaned |> 
  select(Id, Datetime, MEDI) |> 
  mutate(Id = Id |> fct_relabel(\(x) str_remove(x, "THUAS_"))) |> 
grand_overview(coordinates, "Delft", "The Netherlands", 
               country_colors, photoperiod_sequence = 1, map_site_label_color = "white",
               date.handler = \(x) date("2025-04-16") #produces the average photoperiod
               )

ggsave("../output/figures/Figure_1.png", width = 17, height = 10, scale = 2, units = "cm")
ggsave("../output/figures/Figure_1.jpeg", width = 17, height = 10, scale = 2, units = "cm")
```


## Stats

### Summary table

```{r}
#| message: false
#| warning: false

table_summary <-
summary_table(
  data_cleaned, 
  coordinates = coordinates, 
  location = "Delft", 
  site = "The Netherlands", 
  color = country_colors["The Netherlands"],
  histograms = TRUE
)

table_summary

gtsave(table_summary, here("output/tables/table_summary.png"), vwidth = 850, expand = 30)
gtsave(table_summary, here("output/tables/table_summary.pdf"))
gtsave(table_summary |> cols_hide(c(plot)), here("output/tables/table_summary.docx"))

```

